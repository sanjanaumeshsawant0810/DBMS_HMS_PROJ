{% extends 'base.html' %}

{% block title %}Appointments - Admin{% endblock %}

{% block content %}
<div class="fade-in-up">
  <!-- Navigation Tabs -->
  <ul class="nav nav-pills mb-4">
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('admin.patients') }}">Patients</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('admin.doctors') }}">Doctors</a>
    </li>
    <li class="nav-item">
      <a class="nav-link active" href="{{ url_for('admin.appointments') }}">Appointments</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('admin.bills') }}">Billing</a>
    </li>
  </ul>

  <div class="row">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h3 class="mb-1">üìÖ Appointment Management</h3>
          <p class="text-muted mb-0">View and manage all patient appointments</p>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="input-group" style="width: 300px;">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" id="searchAppointments" class="form-control" placeholder="Search patient, doctor, date...">
          </div>
          <div class="d-flex align-items-center gap-2">
            <label for="statusFilter" class="mb-0 text-muted"><i class="bi bi-funnel"></i></label>
            <select id="statusFilter" class="form-select" style="width: auto; min-width: 180px;">
              <option value="all">All Appointments</option>
              <option value="booked">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
      </div>

      {% if rows %}
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Patient</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Doctor</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% for r in rows %}
                  <tr class="appointment-row" data-status="{{ r['status'] }}">
                    <td><span class="badge bg-secondary">{{ r['id'] }}</span></td>
                    <td><strong>{{ r['patient_name'] }}</strong></td>
                    <td>
                      <i class="bi bi-calendar3 text-muted me-1"></i>
                      {{ r['appointment_datetime'].split(' ')[0] if r['appointment_datetime'] else '-' }}
                    </td>
                    <td>
                      <i class="bi bi-clock text-muted me-1"></i>
                      {{ r['appointment_datetime'].split(' ')[1] if r['appointment_datetime'] and ' ' in r['appointment_datetime'] else '-' }}
                    </td>
                    <td>
                      {% if r['doctor_name'] %}
                        <i class="bi bi-person-badge text-primary me-1"></i>{{ r['doctor_name'] }}
                      {% else %}
                        <span class="text-muted">Not assigned</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if r['status'] == 'confirmed' %}
                        <span class="badge bg-success">‚úì Confirmed</span>
                      {% elif r['status'] == 'booked' %}
                        <span class="badge bg-warning text-dark">‚è≥ Pending</span>
                      {% elif r['status'] == 'cancelled' %}
                        <span class="badge bg-danger">‚úó Cancelled</span>
                      {% elif r['status'] == 'completed' %}
                        <span class="badge bg-info">‚úì Completed</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ r['status'] }}</span>
                      {% endif %}
                    </td>
                    <td>{{ r['notes'] or '-' }}</td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#edit{{ r['id'] }}" title="Edit">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                    </td>
                  </tr>
                  <tr class="collapse appointment-edit-row" id="edit{{ r['id'] }}" data-status="{{ r['status'] }}">
                    <td colspan="8" class="bg-light">
                      <div class="p-3">
                        <form method="post" action="{{ url_for('admin.confirm_appointment', aid=r['id']) }}" class="row g-3">
                          <div class="col-md-3">
                            <label class="form-label small fw-bold">Assign Doctor</label>
                            <select name="doctor" class="form-select form-select-sm" required>
                              <option value="">-- Select Doctor --</option>
                              {% for d in doctors %}
                                <option value="{{ d['doctor_id'] }}" {% if d['doctor_id']|string == (r['doctor_id']|default(''))|string %}selected{% endif %}>
                                  Dr. {{ d['f_name'] }} {{ d['l_name'] }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="col-md-2">
                            <label class="form-label small fw-bold">Date</label>
                            <input type="date" name="date" value="{{ r['appointment_datetime'].split(' ')[0] if r['appointment_datetime'] else '' }}" class="form-control form-control-sm" min="2025-12-07" max="2026-12-31">
                          </div>
                          <div class="col-md-2">
                            <label class="form-label small fw-bold">Time</label>
                            <input type="time" name="time" value="{{ r['appointment_datetime'].split(' ')[1] if r['appointment_datetime'] and ' ' in r['appointment_datetime'] else '' }}" class="form-control form-control-sm">
                          </div>
                          <div class="col-md-3">
                            <label class="form-label small fw-bold">Notes</label>
                            <input type="text" name="actions" class="form-control form-control-sm" placeholder="Admin notes" value="{{ r['actions'] or '' }}">
                          </div>
                          <div class="col-md-2 d-flex align-items-end">
                            <input type="hidden" name="edit_dt" value="1">
                            <button type="submit" class="btn btn-sm btn-primary w-100">
                              <i class="bi bi-check-circle me-1"></i>Update
                            </button>
                          </div>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>No appointments found in the system.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const statusFilter = document.getElementById('statusFilter');
  const searchInput = document.getElementById('searchAppointments');
  const appointmentRows = document.querySelectorAll('.appointment-row');
  const appointmentEditRows = document.querySelectorAll('.appointment-edit-row');
  
  function filterAppointments() {
    const filterValue = statusFilter.value;
    const searchTerm = searchInput.value.toLowerCase();
    
    appointmentRows.forEach((row, index) => {
      const rowStatus = row.getAttribute('data-status');
      const editRow = appointmentEditRows[index];
      
      // Get text content for searching
      const rowText = row.textContent.toLowerCase();
      
      // Check both filter and search conditions
      const matchesFilter = filterValue === 'all' || rowStatus === filterValue;
      const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
      
      if (matchesFilter && matchesSearch) {
        row.style.display = '';
        if (editRow) editRow.style.display = '';
      } else {
        row.style.display = 'none';
        if (editRow) {
          editRow.style.display = 'none';
          // Close any open edit forms
          editRow.classList.remove('show');
        }
      }
    });
  }
  
  // Listen to both filter and search changes
  statusFilter.addEventListener('change', filterAppointments);
  searchInput.addEventListener('input', filterAppointments);
});
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}