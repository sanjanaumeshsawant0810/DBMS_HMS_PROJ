{% extends 'base.html' %}
{% block title %}Patient: {{ patient['first_name'] }} {{ patient['last_name'] }} - HMS{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <a class="btn btn-outline-secondary mb-3" href="{{ url_for('doctor.my_patients') }}">â¬… Back to My Patients</a>

    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Patient: {{ patient['first_name'] }} {{ patient['last_name'] }} <small class="text-muted">(ID: {{ patient['id'] }})</small></h4>

        {% if appointments %}
        <div class="mb-4">
          <h5 class="mt-3">Reason for Visit</h5>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Appointment Date & Time</th>
                  <th>Reason for Booking / Notes</th>
                </tr>
              </thead>
              <tbody>
                {% for appt in appointments %}
                <tr>
                  <td>{{ appt['appointment_datetime'] }}</td>
                  <td>{{ appt['notes'] if appt['notes'] else '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        <h5 class="mt-3">Treatment & Prescription Records</h5>
        {% if treatments %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Treatment ID</th>
                <th>Treatment Description</th>
                <th>Date</th>
                <th>Medication</th>
                <th>Dosage</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              {% for t in treatments %}
              {% set treatment_prescriptions = [] %}
              {% for p in prescriptions %}
                {% if p['treatment_id'] == t['id'] %}
                  {% set _ = treatment_prescriptions.append(p) %}
                {% endif %}
              {% endfor %}
              {% if treatment_prescriptions %}
                {% for p in treatment_prescriptions %}
                <tr>
                  <td>{{ t['id'] }}</td>
                  <td>{{ t['description'] }}</td>
                  <td>{{ t['start_date'] or t['end_date'] or '' }}</td>
                  <td>{{ p['medications'] or '-' }}</td>
                  <td>{{ p['dosages'] or '-' }}</td>
                  <td>{{ p['notes'] or '-' }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td>{{ t['id'] }}</td>
                  <td>{{ t['description'] }}</td>
                  <td>{{ t['start_date'] or t['end_date'] or '' }}</td>
                  <td colspan="3" class="text-muted">No prescription linked</td>
                </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="alert alert-info">No treatments recorded.</div>
        {% endif %}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5>Create Prescription and Treatment</h5>
        <form method="POST">
          <input type="hidden" name="action" value="prescribe">
          <div class="mb-3">
            <label for="description" class="form-label">Treatment Description</label>
            <textarea id="description" name="description" rows="3" class="form-control" placeholder="Describe the treatment or diagnosis" required></textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label for="medication_name" class="form-label">Medication name</label>
              <input id="medication_name" name="medication_name" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label for="medication_description" class="form-label">Medication Description</label>
              <input id="medication_description" name="medication_description" class="form-control" placeholder="e.g., Antibiotic, Pain reliever">
            </div>
            <div class="col-md-2">
              <label for="dosage" class="form-label">Dosage</label>
              <input id="dosage" name="dosage" class="form-control">
            </div>
            <div class="col-md-2">
              <label for="duration" class="form-label">Duration</label>
              <input id="duration" name="duration" class="form-control" placeholder="e.g., 7 days">
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-3">
              <label for="unit_price" class="form-label">Unit price</label>
              <input id="unit_price" name="unit_price" class="form-control" value="0">
            </div>
            <div class="col-md-9">
              <label for="notes" class="form-label">Prescription Notes</label>
              <input id="notes" name="notes" class="form-control">
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" type="submit">Create Treatment & Prescription</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}