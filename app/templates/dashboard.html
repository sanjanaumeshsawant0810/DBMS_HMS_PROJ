{% extends 'base.html' %}
{% block title %}Admin Dashboard - HMS{% endblock %}

{% block content %}
<div class="fade-in-up">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="m-0 mb-2">üè• Hospital Admin Dashboard</h2>
      <p class="text-muted mb-0">System overview and key metrics.</p>
    </div>
  </div>

  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <a href="{{ url_for('admin.patients') }}" class="text-decoration-none">
        <div class="stat-card card-hover" style="background: linear-gradient(135deg, #00BFA6 0%, #00D4B5 100%);">
          <div class="stat-card-icon">üë•</div>
          <h5>Total Patients</h5>
          <h3>{{ stats.patients }}</h3>
          <small style="opacity: 0.9;">Active in system</small>
        </div>
      </a>
    </div>
    <div class="col-md-3">
      <a href="{{ url_for('admin.doctors') }}" class="text-decoration-none">
        <div class="stat-card card-hover" style="background: linear-gradient(135deg, #0288D1 0%, #03A9F4 100%);">
          <div class="stat-card-icon">üë®‚Äç‚öïÔ∏è</div>
          <h5>Total Doctors</h5>
          <h3>{{ stats.doctors }}</h3>
          <small style="opacity: 0.9;">Medical staff</small>
        </div>
      </a>
    </div>
    <div class="col-md-3">
      <a href="{{ url_for('admin.appointments') }}" class="text-decoration-none">
        <div class="stat-card card-hover" style="background: linear-gradient(135deg, #9C27B0 0%, #BA68C8 100%);">
          <div class="stat-card-icon">üìÖ</div>
          <h5>Appointments</h5>
          <h3>{{ stats.appointments }}</h3>
          <small style="opacity: 0.9;">Total scheduled</small>
        </div>
      </a>
    </div>
    <div class="col-md-3">
      <a href="{{ url_for('admin.bills') }}" class="text-decoration-none">
        <div class="stat-card card-hover" style="background: linear-gradient(135deg, #FFB84D 0%, #FFC870 100%);">
          <div class="stat-card-icon">üí∞</div>
          <h5>Billing Records</h5>
          <h3>{{ stats.bills }}</h3>
          <small style="opacity: 0.9;">Pending & paid</small>
        </div>
      </a>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4 mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-graph-up text-primary me-2"></i>Appointments Trend (Last 7 Days)
          </h5>
          <canvas id="appointmentsChart" height="80"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-pie-chart text-success me-2"></i>Appointment Status
          </h5>
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue & Doctor Workload Row -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-currency-dollar text-warning me-2"></i>Revenue Overview
          </h5>
          <canvas id="revenueChart" height="100"></canvas>
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Total Revenue:</span>
              <strong class="text-success">‚Çπ{{ "{:,.2f}".format(revenue_stats['total_amount'] or 0) }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Paid:</span>
              <strong class="text-primary">‚Çπ{{ "{:,.2f}".format(revenue_stats['paid_amount'] or 0) }}</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Pending:</span>
              <strong class="text-warning">‚Çπ{{ "{:,.2f}".format(revenue_stats['pending_amount'] or 0) }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-bar-chart text-info me-2"></i>Top 5 Doctors by Appointments
          </h5>
          <canvas id="doctorWorkloadChart" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-lightning-fill text-warning me-2"></i>Quick Actions
          </h5>
          <div class="d-grid gap-2">
            <a href="{{ url_for('admin.add_patient') }}" class="btn btn-outline-primary text-start">
              <i class="bi bi-person-plus-fill me-2"></i>Add New Patient
            </a>
            <a href="{{ url_for('admin.add_doctor') }}" class="btn btn-outline-secondary text-start">
              <i class="bi bi-person-badge me-2"></i>Add New Doctor
            </a>
            <a href="{{ url_for('admin.appointments') }}" class="btn btn-outline-info text-start">
              <i class="bi bi-calendar-check me-2"></i>View Appointments
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-graph-up text-success me-2"></i>System Overview
          </h5>
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <span class="text-muted">Active Patients</span>
            <span class="badge bg-success">{{ stats.patients }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <span class="text-muted">Available Doctors</span>
            <span class="badge bg-info">{{ stats.doctors }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Billing Records</span>
            <span class="badge bg-warning">{{ stats.bills }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

  const appointmentsTrendCtx = document.getElementById('appointmentsChart');
  if (appointmentsTrendCtx) {
    new Chart(appointmentsTrendCtx, {
      type: 'line',
      data: {
        labels: [{% for row in recent_appointments %}'{{ row["date"] }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
          label: 'Appointments',
          data: [{% for row in recent_appointments %}{{ row["count"] }}{% if not loop.last %},{% endif %}{% endfor %}],
          borderColor: isDarkMode ? '#00897B' : '#00BFA6',
          backgroundColor: isDarkMode ? 'rgba(0, 137, 123, 0.1)' : 'rgba(0, 191, 166, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  const statusCtx = document.getElementById('statusChart');
  if (statusCtx) {
    new Chart(statusCtx, {
      type: 'doughnut',
      data: {
        labels: [{% for row in appointment_stats %}'{{ row["status"]|capitalize }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
          data: [{% for row in appointment_stats %}{{ row["count"] }}{% if not loop.last %},{% endif %}{% endfor %}],
          backgroundColor: isDarkMode 
            ? ['#388E3C', '#FB8C00', '#D32F2F', '#1E88E5']
            : ['#4CAF50', '#FF9800', '#F44336', '#2196F3']
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  const revenueCtx = document.getElementById('revenueChart');
  if (revenueCtx) {
    new Chart(revenueCtx, {
      type: 'bar',
      data: {
        labels: ['Paid', 'Pending'],
        datasets: [{
          data: [{{ revenue_stats['paid_amount'] or 0 }}, {{ revenue_stats['pending_amount'] or 0 }}],
          backgroundColor: isDarkMode
            ? ['rgba(56, 142, 60, 0.8)', 'rgba(251, 140, 0, 0.8)']
            : ['rgba(76, 175, 80, 0.8)', 'rgba(255, 152, 0, 0.8)'],
          borderColor: isDarkMode
            ? ['#388E3C', '#FB8C00']
            : ['#4CAF50', '#FF9800'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  const doctorWorkloadCtx = document.getElementById('doctorWorkloadChart');
  if (doctorWorkloadCtx) {
    new Chart(doctorWorkloadCtx, {
      type: 'bar',
      data: {
        labels: [{% for row in doctor_workload %}'{{ row["doctor_name"] }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
          label: 'Appointments',
          data: [{% for row in doctor_workload %}{{ row["appointment_count"] }}{% if not loop.last %},{% endif %}{% endfor %}],
          backgroundColor: isDarkMode ? 'rgba(1, 87, 155, 0.8)' : 'rgba(2, 136, 209, 0.8)',
          borderColor: isDarkMode ? '#01579B' : '#0288D1',
          borderWidth: 2
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true } }
      }
    });
  }
});
</script>
{% endblock %}
